<html>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <script>
        var canvas;
        var canvasContext;
        var ballX = 50;
        var ballSpeedX = 10;
        var ballY = 50;
        var ballSpeedY = 4;
        var leftPaddleX
        var leftPaddleY = 250;
        var rightPaddleX
        var rightPaddleY = 250;
        var displayWin = false;
        var p1Score = 0;
        var p2Score = 0;
        const winScore = 3;
        const paddleHeight = 85;
        const paddleWidth = 10;

        function locateMouse(event) {
            var rect = canvas.getBoundingClientRect();
            var root = document.documentElement;
            var mouseX = event.clientX - rect.left - root.scrollLeft;
            var mouseY = event.clientY - rect.top - root.scrollTop;
            return {
                x:mouseX,y:mouseY
            }
        }

        window.onload = function() {
            //console.log("Start");
            canvas = document.getElementById('gameCanvas');
            canvasContext = canvas.getContext('2d');
            
            var fps = 30;
            setInterval(drawAndMove, 1000/fps)

            canvas.addEventListener('mousemove',
                function(event) {
                    var mouseLoc = locateMouse(event);
                    leftPaddleY = mouseLoc.y-(paddleHeight/2);
                });
        }

        function drawAndMove() {
            moveAll();
            drawAll();
        }

        function ballReset() {
            if (p1Score >= winScore || p2Score >= winScore) {
                p1Score = 0;
                p2Score = 0;
                displayWin = true;
            }

            ballSpeedX = -ballSpeedX;
            ballX = canvas.width/2;
            ballY = canvas.height/2;
        }

        function npcMovement() {
            var rightCenterPadY = rightPaddleY + (paddleHeight/2)
            if (rightCenterPadY < ballY-35) {
                rightPaddleY += 6;
            } else if(rightCenterPadY > ballY+35){
                rightPaddleY -= 6;
            }
        }

        function moveAll() {
            if(displayWin) {
                return;
            }

            npcMovement();

            ballX += ballSpeedX;
            ballY += ballSpeedY;
            //if (ballX >= canvas.width) {
            //    ballSpeedX = -ballSpeedX;
            //}
            if (ballX < 0) {
                if (ballY > leftPaddleY &&
                    ballY < leftPaddleY+paddleHeight) {
                        ballSpeedX = -ballSpeedX

                        var deltaY = ballY - (rightPaddleY+(paddleHeight/2))
                        ballSpeedY = deltaY * 0.10;
                    } else {
                        p2Score += 1;
                        ballReset();
                    }
            }
            if (ballX > 800) {
                if (ballY > rightPaddleY &&
                    ballY < rightPaddleY+paddleHeight) {
                        ballSpeedX = -ballSpeedX;

                        var deltaY = ballY - (leftPaddleY+(paddleHeight/2))
                        ballSpeedY = deltaY * 0.10;
                    } else {
                        p1Score += 1;
                        ballReset();
                    }
            }
            if (ballY >= canvas.height) {
                ballSpeedY = -ballSpeedY;
            }
            if (ballY < 0) {
                ballSpeedY = -ballSpeedY;
            }
        }

        function drawAll() {
            //background
            colorRect(0,0,canvas.width,canvas.height,'black');

            if(displayWin) {
                canvasContext.fillStyle = "white";
                canvasContext.fillText("Click to Continue", 100, 100);
                return;
            }

            //left paddle
            colorRect(15,leftPaddleY,paddleWidth,90,'white');

            //right paddle
            colorRect(775,rightPaddleY,paddleWidth,90,'white');

            //ball
            canvasContext.beginPath()
            colorRect(ballX,ballY,15,15,'green');
            canvasContext.fill()

            canvasContext.fillText(p1Score, 100, 100)
            canvasContext.fillText(p2Score, canvas.width-100, 100)
        }

        function colorRect(leftX,topY, width,height, drawColor) {
            canvasContext.fillStyle = drawColor;
            canvasContext.fillRect(leftX,topY, width,height);
        }
    </script>
</html>